---
- name: AlmaLinux
  hosts: default
  become: true

- name: Remove firewall and linux-firmware
  dnf:
    name:
      - firewalld
      - firewalld-filesystem
      - ipset
      - ipset-libs
      - iptables
      - python3-firewall
      - python3-slip
      - libnftnl
      - libnfnetlink
      - linux-firmware
      - geolite2-city
      - geolite2-country
      - bind-export-libs
    state: absent

- name: Find persistent-net.rules
  find:
    paths: /etc/udev/rules.d
    patterns: 70*
  register: net_rules

- name: Delete persistent-net.rules
  file:
    path: "{{ item.path }}"
    state: absent
  with_items: "{{ net_rules.files }}"

- name: Configure /etc/sysconfig/network
  lineinfile:
    path: /etc/sysconfig/network
    line: "{{ item }}"
  with_items:
    - NETWORKING=yes
    - NOZEROCONF=yes

- name: Disable consistent network device naming
  file:
    src: /dev/null
    dest: /etc/udev/rules.d/80-net-name-slot.rules
    owner: root
    group: root
    state: link

- name: Blacklist nouveau kernel module
  lineinfile:
    path: /etc/modprobe.d/blacklist-nouveau.conf
    line: blacklist nouveau
    create: true
    owner: root
    group: root
    mode: 0644

- name: Disable firstboot
  lineinfile:
    path: /etc/sysconfig/firstboot
    line: RUN_FIRSTBOOT=NO
    create: true
    owner: root
    group: root
    mode: 0644

- name: Disable root login
  user:
    name: root
    password: '!!'

- name: Disable virtual terminals allocation by logind
  replace:
    dest: '/etc/systemd/logind.conf'
    regexp: '^#?NAutoVTs=\d+'
    replace: 'NAutoVTs=0'

- name: Install additional software
  dnf:
    name:
      - cloud-init
      - cloud-utils-growpart
      - dracut-config-generic
      - gdisk
      - rsync
      - tar
      - qemu-guest-agent
      - yum-utils
    state: present

- name: Enable cloud-init services
  service:
    name: "{{ item }}"
    enabled: true
  with_items:
    - cloud-config
    - cloud-init
    - cloud-init-local
    - cloud-final

- name: Delete /etc/sysconfig/qemu-ga
  file:
    state: absent
    path: /etc/sysconfig/qemu-ga

- name: Configure qemu guest agent
  lineinfile:
    path: /etc/sysconfig/qemu-ga
    line: "{{ item }}"
    create: true
    owner: root
    group: root
    mode: 0644
  with_items:
    - BLACKLIST_RPC=
    - FSFREEZE_HOOK_PATHNAME=/etc/qemu-ga/fsfreeze-hook

- name: Enable sgdisk in dracut
  lineinfile:
    path: /etc/dracut.conf.d/sgdisk.conf
    line: 'install_items+=" sgdisk "'
    create: true
    owner: root
    group: root
    mode: 0644

- name: Upgrade initramfs
  command: dracut -f --regenerate-all

- name: Remove old kernels
  shell: dnf remove -y $(dnf repoquery --installonly --latest-limit=-1 -q)

- name: Delete DNF cache
  command: dnf clean all

- name: Find temporary files
  find:
    file_type: any
    paths:
      - /tmp
      - /var/tmp
    patterns: '*'
  register: tmp_files

- name: Remove temporary files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ tmp_files.files }}"

- name: Remove SSH host keys
  block:
    - name: Find SSH host keys
      find:
        paths: /etc/ssh
        patterns: '*host*key*'
      register: host_keys

    - name: Remove SSH host keys
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ host_keys.files }}"
  when: cleanup_ssh_host_keys | bool

- name: Remove kickstart files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /root/anaconda-ks.cfg
    - /root/original-ks.cfg

- name: Truncate files
  command: "truncate -s 0 {{ item }}"
  loop:
    - /etc/machine-id
    - /var/log/audit/audit.log
    - /var/log/wtmp
    - /var/log/lastlog
    -
- name: Fill free space with zeroes
  shell: dd if=/dev/zero of=/zeroed_file bs=1M oflag=direct || /bin/true

- name: Remove zeroed file
  file:
    path: /zeroed_file
    state: absent

- name: Sync disc
  command: sync

- name: Clear shell history
  shell: history -c

cleanup_ssh_host_keys: true
